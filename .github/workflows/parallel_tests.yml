name: LAVA Tests

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master

# Automatically cancel any previous workflow on new push.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  test_debian_package:
    if: github.repository == 'panda-re/lava'
    runs-on: ubuntu-22.04
    env:
      LLVM_DIR: /usr/lib/llvm-11
      DEBIAN_FRONTEND: noninteractive
    steps:  
      - name: Checkout LAVA at current commit
        uses: actions/checkout@v4
      
      - name: Create Wheel File
        run: |
          sudo apt-get update -y
          sudo apt-get install clang-tools-11 libclang-11-dev llvm-11-dev odb libjsoncpp-dev libodb-pgsql-2.4 g++-10 libprotobuf-dev libprotobuf-c-dev -y
      #    python3 -m pip install build
      #    python3 -m build --wheel .

      - name: Create Debian Package
        run: |
          cmake -B"./tools/build" \
          -H"./tools" \
          -DCMAKE_INSTALL_PREFIX="/usr" \
          -DCMAKE_BUILD_TYPE=Release
          cmake --build "./tools/build" --parallel "$(nproc)" --config Release
          cd ./tools/build
          cpack -G DEB

  test_install_script:
    if: github.repository == 'panda-re/lava'
    runs-on: ubuntu-22.04
    env:
      LLVM_DIR: /usr/lib/llvm-11
      DEBIAN_FRONTEND: noninteractive
      USER: ${{ github.actor }}
      # https://docs.github.com/en/actions/use-cases-and-examples/using-containerized-services/creating-postgresql-service-containers
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgrespostgres
          POSTGRES_DB: toy_${{ env.USER }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U ${POSTGRES_USER}"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    - name: Update and install all requirements
      run: bash install.sh
    - name: Setup LAVA
      run: |
        chmod +x ./scripts/*
        python3 init-host.py
    - name: Add Postgres credentials and Run LAVA
      run: |
        echo "localhost:5432:*:${POSTGRES_USER}:${POSTGRES_PASSWORD}" > ~/.pgpass
        chmod 600 ~/.pgpass
        ./scripts/lava.sh -ak toy
      env:
        USER: ${{ github.actor }}
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgrespostgres
        CI: false

  # For now I am pushing LAVA, but eventually this should be just a testing repostiory
  build_container:
    if: github.repository == 'panda-re/lava'
    runs-on: ubuntu-22.04
    env:
      LLVM_DIR: /usr/lib/llvm-11
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: 'Login to Docker Registry'
        uses: docker/login-action@v3
        with:
          username: pandare
          password: ${{secrets.ALL_PANDARE_DOCKERHUB}}
    
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."${{ secrets.PANDA_ARC_REGISTRY }}"]
              insecure = true
              http = true

      - name: Check out
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          push: true
          tags: |
            pandare/lava:latest
